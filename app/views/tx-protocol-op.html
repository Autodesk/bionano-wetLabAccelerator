<div class="protocol-op-wrap"
     ng-mouseenter="hovering = true"
     ng-mouseleave="hovering = false">
  <div class="verification"
       ng-class="{'expanded' : opCtrl.isVisible}"
       ng-if="opCtrl.verification">
    <div class="verification-alert">
      <span class="glyphicon glyphicon-alert"></span>
    </div>
    <div class="verification-flag"
         ng-class="{'op-open' : opCtrl.isVisible}">
      <span ng-bind="opCtrl.verification.message"></span>
    </div>
  </div>

  <div class="operation-name"
       ng-click="opCtrl.isVisible = !opCtrl.isVisible">
    <span ng-bind="opCtrl.op.operation"></span>

    <div class="dropdown group-items"
         ng-show="hovering"
         ng-click="$event.stopPropagation();"
         ng-class="{'open' :showActions}">
      <img src="/images/zero_iterations.png"
           ng-show="!opCtrl.op.loop || opCtrl.op.loop <= 1">
      <div class="group-repeat"
           ng-show="opCtrl.op.loop && opCtrl.op.loop >= 2">
        <input class="input-unstyled"
               type="number" min="1" max="100"
               ng-model-options="{updateOn: 'blur'}"
               ng-model="opCtrl.op.loop"/>
      </div>
      <span class="glyphicon glyphicon-cog"
            ng-click="opCtrl.toggleActionsMenu($event)"></span>
      <ul class="dropdown-menu dropdown-menu-right"
          ng-mouseleave="opCtrl.toggleActionsMenu($event)">
        <li>
          <a ng-click="opCtrl.toggleModal($event)">
            Verify Protocol
          </a>
        </li>
        <li>
          <a ng-click="opCtrl.toggleJsonEditing($event)">
          Show JSON
          </a>
        </li>
        <li>
          <a ng-click="deleteStep()">
          Delete Step
          </a>
        </li>
      </ul>
    </div>
  </div>

  <div class="operation-fields"
       ng-show="opCtrl.isVisible">
    <tx-protocol-field ng-model="opCtrl.op.description"
                       field="{name: 'description', type: 'string'}">
    </tx-protocol-field>
    <tx-protocol-field ng-repeat="field in opCtrl.op.fields"
                       ng-model="field.value"
                       field="field">
    </tx-protocol-field>
  </div>

  <tx-modal ng-show='modalShown'>
    <tx-run></tx-run>
  </tx-modal>

  <div class="pre-scrollable modal-background"
       ng-class="{'open' : jsonEditing}">
    <span class="modal-close"
          ng-click="jsonEditing = false">&times</span>
    <pre json-editor
         ng-if="jsonEditing"
         contenteditable
         json-editor-active="{{jsonEditing}}"
         name="ProtocolStepEditor"
         ng-model="opCtrl.op"
         ng-model-options="{updateOn: 'blur'}">
    </pre>
  </div>

  <tx-operation-popover ng-if="opCtrl.isHovered"
                        ng-hide="opCtrl.isVisible || opCtrl.verification"
                        operation="opCtrl.op"></tx-operation-popover>
</div>
